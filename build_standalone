#!/bin/bash

CXFREEZEFILE=setup-cf_Freeze.py

assertnotempty(){
	# Assert string is not empty, or print error message 
	if [ "$1" == '' ]
	then
		echo $2 
		exit 1
	fi
}

checkexecutableinpath(){
	# Check if executable $1 is present.
	if [ "$(which $1)" == '' ]
	then
		echo $1 NOT installed. Please install it to proceed.
		exit 1
	else
		echo $1 installed...
	fi
}

checkexecutablesinpath(){
	checkexecutableinpath python 
	checkexecutableinpath cxfreeze
}

set -e 

CURRDIR=$(dirname $0)
CURRLINUXDIST=$(cat /etc/issue)
CURRUNAME=$(uname -a)

echo Current directory is $CURRDIR
echo Current Linux distribution is $CURRLINUXDIST
echo Current uname is $CURRUNAME 

checkexecutablesinpath 
python $CXFREEZEFILE build

BTEMP=$(ls $CURRDIR/build)
echo Build path detected: $BTEMP

BUILDPATH=$(readlink -f $CURRDIR/build/$BTEMP)
echo Build path detected: $BUILDPATH

echo Building needed libraries...
$CURRDIR/build_lxml

echo Checking if libraries were built...
LIBEXSLT=$(find . -name libexslt.so.0.8.15)
assertnotempty "$LIBEXSLT" "ERROR: The libraries generated by the script build_lxml were not found."
PATHTOLIBS=$(dirname $LIBEXSLT)
echo Libraries generated in $PATHTOLIBS

echo Copying libraries in distributable...
cp $PATHTOLIBS/libexslt.so.0.8.15 $BUILDPATH
ln -s $BUILDPATH/libexslt.so.0.8.15 $BUILDPATH/libexslt.so
ln -s $BUILDPATH/libexslt.so.0.8.15 $BUILDPATH/libexslt.so.0
cp $PATHTOLIBS/libxml2.so.2.7.8 $BUILDPATH
ln -s $BUILDPATH/libxml2.so.2.7.8 $BUILDPATH/libxml2.so
ln -s $BUILDPATH/libxml2.so.2.7.8 $BUILDPATH/libxml2.so.2
cp $PATHTOLIBS/libxslt.so.1.1.26 $BUILDPATH
ln -s $BUILDPATH/libxslt.so.1.1.26 $BUILDPATH/libxslt.so
ln -s $BUILDPATH/libxslt.so.1.1.26 $BUILDPATH/libxslt.so.1

echo Done.
